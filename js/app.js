function getURLParameter(e){return decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null}function calc_note(e){var t=0,a=0;if(Object.keys(e).forEach(function(s){var s=e[s];Object.keys(s.classes).forEach(function(e){var e=s.classes[e];e.use&&e.note>=1&&(t+=e.note*e.weight,a+=e.weight)})}),a>0){var s=t/a,r=find_strikes(e,t,a);return{note:s,strikes:r}}return{note:0,strikes:{}}}function find_strikes(e,t,a){for(var s=!0,r=a,n=t,i={};s;)s=!1,Object.keys(e).forEach(function(t){if(area=e[t],!area.unstrikeable){var a,o=n/r;if(Object.keys(area.classes).forEach(function(e){var t=area.classes[e];if(t.use&&t.note>=1){var s=r-t.weight,i=(n-t.note*t.weight)/s;o>i&&(o=i,a=e)}}),void 0!=a){if(void 0==i[t]){s=!0;var d=area.classes[a];r-=d.weight,n-=d.note*d.weight}i[t]=a}}});return{strikes:i,note:n/r}}function load_from_url(){var e=getURLParameter("save"),t=getURLParameter("sem_view");return null!=e?(e=decodeURIComponent(e),t=decodeURIComponent(t),classes=JSON.parse(e),sem_view=JSON.parse(t),console.log("Loaded state from URL"),!0):!1}function register_row(e,t){var a=next_id;next_id+=1;var s=classes[e];return t.use=!0,s.classes[a]=t,void 0==s.classes[a].sem&&(s.classes[a].sem=5),a}function create_area(e){var t=e.name;classes[t]={name:e.name,classes:{},modifiable:e.modifiable,unstrikeable:e.unstrikeable},e.classes.forEach(function(e){register_row(t,e)})}function check_new(e){var t={},a=!1;return t.name=$("#"+e+" .add-class input.name").val(),t.note=parseFloat($("#"+e+" .add-class input.note").val()),t.weight=parseFloat($("#"+e+" .add-class input.weight").val()),unmark_error($("#"+e+" .add-class input.note")),unmark_error($("#"+e+" .add-class input.weight")),(Number.isNaN(t.note)||t.note<1||t.note>4)&&(mark_error($("#"+e+" .add-class input.note")),a=!0),(Number.isNaN(t.weight)||t.weight<=0)&&(mark_error($("#"+e+" .add-class input.weight")),a=!0),a?!1:(register_row(e,t),!0)}function cancel(e){return e.preventDefault&&e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="move",!1}function tbody_handle_drop(e){e.preventDefault();var t=e.originalEvent.dataTransfer.getData("text/plain"),a=$("#"+t);a.css("opacity",1);var s=$(this),r=s.attr("data-sid"),n=a.attr("data-rid"),i=a.attr("data-fb");return a.appendTo(s),classes[i].classes[n].sem=r,e.stopPropagation&&e.stopPropagation(),!1}function tr_handle_drop(e){event.preventDefault();var t=e.originalEvent.dataTransfer.getData("text/plain"),a=$("#"+t);a.css("opacity",1);var s=$(this),r=s.offset().top-$(window).scrollTop(),n=s.height()/2,i=e.originalEvent.clientY-r,o=s.index()-a.index();i>n&&-1!=o||1==o?a.insertAfter(s):a.insertBefore(s);var d=a.attr("data-rid"),l=a.attr("data-fb"),c=s.attr("data-rid"),u=s.attr("data-fb");return classes[l].classes[d].sem=classes[u].classes[c].sem,e.stopPropagation&&e.stopPropagation(),!1}function mk_table_row(e,t,a,s){var r=classes[e],n=r.classes[t],i="<tr id='class-"+t+"' data-fb='"+e+"' data-rid="+t+" class='weight-"+get_shade(n.weight)+"'><td>"+n.name+"</td>";i+="<td class='num'><input class='form-control' type='text' maxlength='3' value='"+n.note+"'></td>",i+="<td class='num'>"+n.weight+"</td>",a&&(i+="<td class='del'><a href='#'><i class='fa fa-minus-square'></i></a></td>"),i+="</tr>";var o=$(i);return o.find("input").change(function(e){r.classes[t].note=parseFloat($(this).val()),update_display()}),o.find("td.del a").click(function(e){e.preventDefault(),delete r.classes[t],o.remove(),update_view(sem_view),update_display()}),s&&(o.attr("draggable","true"),o.bind("dragover",cancel),o.bind("dragstart",function(e){this.style.opacity="0.4",e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("text/plain",this.id)}),o.bind("dragend",function(e){this.style.opacity=1}),o.bind("drop",tr_handle_drop)),o}function mk_input_row(e){tr_text="<tr class='add-class'>",tr_text+="<td><input class='name'/></td>",tr_text+="<td class='num'><input maxlength=3 class='note form-control'/></td>",tr_text+="<td class='num'><input maxlength=1 class='weight form-control'/></td>",tr_text+="<td class='add'><a href='#'><i class='fa fa-plus-square'></i></a></td></tr>",tr_text+="</tr>";var t=$(tr_text);return t.find("input").on("keyup",function(t){t.preventDefault(),13==t.keyCode&&check_new(e)&&(update_view(sem_view),update_display())}),t.find("td.add a").click(function(t){t.preventDefault(),check_new(e)&&(update_view(sem_view),update_display())}),t}function get_url(){var e=JSON.stringify(classes);e=encodeURIComponent(e);var t=window.location.protocol+"//"+window.location.host+window.location.pathname,a=t+"?save="+e+"&sem_view="+sem_view;return a}function get_shade(e){return 6>e?1:8>e?2:10>e?3:4}function unmark_error(e){e.removeClass("error")}function mark_error(e){e.addClass("error")}function update_view(e){$("table:not(#temp)").remove();var t=$("table#temp");if(e){for(var a=1;6>=a;a++){tbody_text="<tbody id=sem-"+a+" data-sid="+a+">",tbody_text+="<tr class='area-title'>",tbody_text+="<th colspan='3'>Semester "+a+"</th>",tbody_text+="</tr></tbody>";var s=$(tbody_text);s.bind("drop",tbody_handle_drop),s.bind("dragover",cancel),t.append(s)}Object.keys(classes).forEach(function(e){var t=classes[e];Object.keys(t.classes).forEach(function(a){var s=t.classes[a],r=mk_table_row(e,a,t.modifiable,!0),n=$("#sem-"+s.sem);r.appendTo(n)})})}else Object.keys(classes).forEach(function(e){var a=classes[e],s=a.name.replace(/-/g," ");tbody_text="<tbody id="+a.name+">",tbody_text+="<tr class='area-title'><th colspan='3'>"+s+"</th></tr>",tbody_text+="</tbody>";var r=$(tbody_text);if(a.modifiable){var n=mk_input_row(e);n.appendTo(r)}t.append(r),Object.keys(a.classes).forEach(function(t){var s=mk_table_row(e,t,a.modifiable,!1);a.modifiable?s.insertBefore($("#"+e+" .add-class")):s.appendTo($("#"+e))})});e?$("a#switch-view").text("Semester"):$("a#switch-view").text("Fachbereich"),arrange_tbodies()}function create_table(e){var t="<table id=t"+e+" class='classes'>";return t+="<thead><tr>",t+="<th>Titel</th>",t+="<th class='num'>Note</th>",t+="<th class='num'>Gewicht</th>",t+="<th></th>",t+="</tr></thead></table>"}function arrange_tbodies(){var e=$("table#temp").width(),t=$("table#temp").height(),a=$(window).height()-$("form").offset().top,s=$(window).width(),r=Math.floor(s/e);t>r*a&&(a=t/r);var n=1,i=$(create_table(n));i.appendTo($("form")),$("tbody").each(function(t){var t=$(this),r=i.height()+t.height();t.detach(),r>a-20&&s>(n+1)*e&&(n+=1,i=$(create_table(n)),i.appendTo($("form"))),t.appendTo(i)})}function update_display(){var e=calc_note(classes);$(".strike").removeClass("strike"),e.note>0&&(display_note(e.note,e.strikes.note),Object.keys(e.strikes.strikes).forEach(function(t){var a=e.strikes.strikes[t],s=$("#class-"+a);s.addClass("strike")}))}function display_note(e,t){if(e>0){var a;a=e!=t?"<span class='strike'>"+e.toFixed(2)+"</span> "+t.toFixed(2):e.toFixed(2),$("#overall-note").html(a),$("#overall-note").removeClass("invisible")}else $("#overall-note").addClass("invisible")}var next_id=1,classes={},sem_view=!1;$(document).ready(function(){load_from_url()?(update_view(sem_view),update_display()):$.getJSON("js/studiengaenge/b_inf.json",function(e){e.forEach(create_area),console.log("Loaded default classes"),update_view(sem_view),update_display()}),$("a#switch-view").click(function(e){e.preventDefault(),sem_view=!sem_view,update_view(sem_view),update_display()}),$("a#save").click(function(e){e.preventDefault();var t=get_url();$("input#url").css("display","inline"),$("input#url").val(t),$("input#url").select();var a=document.execCommand("copy");console.log("Saved URL to clipboard: "+a),$("input#url").addClass("hidden")})});